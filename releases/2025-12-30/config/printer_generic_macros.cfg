######################################################################
# Generic Pause/Resume Macros (ACE-agnostic)
# External/consumer macros expected elsewhere:
# - CUT_TIP (optional if using PAUSE with cut_filament)
# - TO_THROW_POSITION (used during pause/resume purge)
# - RESUME_NOZZLE_WIPE_SEQUENCE (used during resume purge)
# - _ACE_STATE (optional: used in RESUME to reload tool when ACE enabled)
######################################################################

# Pause/Resume state that is not ACE-specific (also used when ACE is off)
[gcode_macro _PAUSE_RESUME_STATE]
variable_pause_nozzle_timeout_triggered: 0
variable_pre_pause_temp: 0
gcode:
  # no gcode — just holds variables

[gcode_macro INSERT_EXTRUDE_50]
description: Extrude additional 50mm after filament insert
gcode:
    M83
    G92 E0
    G1 E50 F300
    G92 E0

[gcode_macro INSERT_RESUME_PRINT]
description: Resume print after filament insert prompt
gcode:
    RESPOND TYPE=command MSG=action:prompt_end
    RESUME

[gcode_macro INSERT_CANCEL_PRINT]
description: Cancel print from filament insert prompt
gcode:
    RESPOND TYPE=command MSG=action:prompt_end
    CANCEL_PRINT

[gcode_macro INSERT_LOAD_FILAMENT]
description: Load filament from idle insert prompt
gcode:
  RESPOND TYPE=command MSG=action:prompt_end
  LOAD_FILAMENT

[gcode_macro INSERT_DISMISS]
description: Dismiss filament insert dialog
gcode:
  RESPOND TYPE=command MSG=action:prompt_end

[gcode_macro RUNOUT_DISMISS]
description: Close runout dialog
gcode:
    RESPOND TYPE=command MSG=action:prompt_end

[gcode_macro RUNOUT_CANCEL_PRINT]
description: Cancel print from runout dialog
gcode:
    RESPOND TYPE=command MSG=action:prompt_end
    CANCEL_PRINT


######################################################################
# Enhanced Pause/Resume
######################################################################

[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
variable_nozzle_timeout_seconds: 600
variable_standby_nozzle_temp: 150
gcode:
  {% set z = params.Z|default(10)|int %}
  {% set cut_filament = params.CUT_FILAMENT|default(0)|int %}
  {% set standby = params.STANDBY|default(0)|int %}

  {% if printer['pause_resume'].is_paused|int == 0 %}
    SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE={z}
    SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=etemp VALUE={printer['extruder'].target}

    {% set current_target = printer.extruder.target|int %}
    {% if current_target > 0 %}
      SET_GCODE_VARIABLE MACRO=_PAUSE_RESUME_STATE VARIABLE=pre_pause_temp VALUE={current_target}
      {action_respond_info("ANY[m]: PAUSE: Saved pre-pause temp: %d°C" % current_target)}
    {% endif %}

    BASE_PAUSE

    SAVE_GCODE_STATE NAME=PAUSE_LOCAL
      G90
      M82
      VEL_PUSH
      SET_VELOCITY_LIMIT ACCEL=5000 ACCEL_TO_DECEL=2500 VELOCITY=200 SQUARE_CORNER_VELOCITY=5

      {% if cut_filament == 1 %}
        {action_respond_info("ANY[m]: PAUSE: Cutting filament")}
        CUT_TIP
      {% else %}
        {action_respond_info("ANY[m]: PAUSE: Moving to throw position")}
      {% endif %}
      
      G91
      G1 Z3 F1500 # Lift nozzle before moving (25mm/s)
      G90
      
      TO_THROW_POSITION
      VEL_POP
      RESTORE_GCODE_STATE NAME=PAUSE_LOCAL MOVE=0

    {% if standby == 1 and printer['extruder'].target|int > 0 %}
      {% set target = printer['extruder'].target|int %}
      {% set standby_drop = 20 %}
      {% set standby_temp = (target - standby_drop) if (target - standby_drop) > 0 else 0 %}
      M104 S{standby_temp}
      {action_respond_info("ANY[m]: PAUSE: Immediate standby mode - nozzle at %s°C" % standby_temp)}
    {% else %}
      {% set timeout = printer["gcode_macro PAUSE"].nozzle_timeout_seconds|int %}
      {action_respond_info("ANY[m]: PAUSE: Nozzle will auto-cool to standby after %s seconds" % timeout)}
      UPDATE_DELAYED_GCODE ID=PAUSE_NOZZLE_TIMEOUT DURATION={timeout}
    {% endif %}

    SET_IDLE_TIMEOUT TIMEOUT=43200
    SET_GCODE_VARIABLE MACRO=_PAUSE_RESUME_STATE VARIABLE=pause_nozzle_timeout_triggered VALUE=0

  {% endif %}


[delayed_gcode PAUSE_NOZZLE_TIMEOUT]
gcode:
    {% if printer['pause_resume'].is_paused|int == 1 %}
        {% set standby_temp = printer["gcode_macro PAUSE"].standby_nozzle_temp|int %}
        { action_respond_info("ANY[m]: Pause timeout reached, lowering to standby temp %d°C" % standby_temp) }
        M104 S{standby_temp}
        SET_GCODE_VARIABLE MACRO=_PAUSE_RESUME_STATE VARIABLE=pause_nozzle_timeout_triggered VALUE=1
    {% endif %}

[gcode_macro RESUME]
rename_existing: BASE_RESUME
variable_zhop: 0
variable_etemp: 0
gcode:
    { action_respond_info("ANY[m] [RESUME] initiated") }
    #In case resume was called from RESUME PROMPT, close the prompt
    RESPOND TYPE=command MSG=action:prompt_end
    {% set client_vel = printer.configfile.settings.pause_resume.recover_velocity|default(50.0) %}
    
    # Optional purge override parameter
    {% set purge_amount = params.PURGE|default(40)|float %}

    {% if printer['pause_resume'].is_paused|int == 1 %}
        ; Cancel the nozzle timeout timer
        UPDATE_DELAYED_GCODE ID=PAUSE_NOZZLE_TIMEOUT DURATION=0
        
        ; Restore standard idle timeout now that we're resuming
        SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}

        ; Wrap EVERYTHING we touch so modal F/coords/E-mode can't leak
        SAVE_GCODE_STATE NAME=RESUME_WRAP

        ; Reheat if needed (uses stored target from PAUSE)
        {% if etemp > 0 %}
          {% set timeout_triggered = printer["gcode_macro _PAUSE_RESUME_STATE"].pause_nozzle_timeout_triggered|int %}
            {% if timeout_triggered == 1 %}
                { action_respond_info("ANY[m]: RESUME: Reheating nozzle from standby to=%f°C" % etemp) }
            {% endif %}
            MOVE_HEAT_POS
            M109 S{etemp|int}
        {% endif %}

        ; Flag to track if resume should proceed
        {% set resume_ok = true %}

        ; Re-activate ACE tool if enabled
        {% if printer["output_pin ACE_Pro"] is defined and printer["output_pin ACE_Pro"].value %}
          { action_respond_info("ANY[m]: (Re)activate Tool") }
          {% set active_tool = printer["gcode_macro _ACE_STATE"].active %}
          {% if active_tool >= 0 %}
              ; Attempt to load the tool
              T{active_tool}
              M400  ; Wait for all moves to complete
          {% else %}
            { action_respond_info("ANY[m]: active_tool=%s" % active_tool) }
          {% endif %}
        {% endif %}

        G92 E0
        { action_respond_info("ANY[m]: Extruder position reset to E=0") }

        ; --- Purge and wipe (skip if PURGE=0) ---
        {% if purge_amount > 0 %}
            TO_THROW_POSITION
            ; --- Small, safe prime with optional override ---
            {% set was_abs_e = printer.gcode_move.absolute_extrude %}
            M83
            { action_respond_info("ANY[m]: Purging %fmm filament" % purge_amount) }
            G1 E{purge_amount} F300
            {% if was_abs_e %} M82 {% endif %}

            # Enable this is wiping the nozzle at resume is prefered:
            { action_respond_info("ANY[m]: [RESUME]Wipe nozzle") }
            ; --- keep wipe/throw side-effects contained ---
            SAVE_GCODE_STATE NAME=RESUME_LOCAL
            VEL_PUSH
            SET_VELOCITY_LIMIT ACCEL=5000 ACCEL_TO_DECEL=2500 VELOCITY=200 SQUARE_CORNER_VELOCITY=5
            RESUME_NOZZLE_WIPE_SEQUENCE
            G1 E1 F300
            VEL_POP
            RESTORE_GCODE_STATE NAME=RESUME_LOCAL MOVE=0
            ; ---------------------------------------------
        {% else %}
            { action_respond_info("ANY[m]: Skipping purge and wipe (PURGE=0)") }
        {% endif %}

        G92 E0
        { action_respond_info("ANY[m]: Extruder position reset to E=0 (final)") }
        RESTORE_GCODE_STATE NAME=RESUME_WRAP MOVE=0

        {% if printer["output_pin ACE_Pro"] is defined and printer["output_pin ACE_Pro"].value %}
          { action_respond_info("ANY[m]: ACE resume finished") }
        {% endif %}
        BASE_RESUME VELOCITY={params.VELOCITY|default(client_vel)}
    {% else %}
      { action_respond_info("ANY[m] [RESUME] called, but currently not in PAUSED state") }
    {% endif %}


######################################################################
# Velocity stack (shared)
######################################################################

[gcode_macro VEL_PUSH]
variable_stack: []
gcode:
  {% set cur = printer["gcode_macro VEL_PUSH"].stack %}
  {% set s = cur + [(printer.toolhead.max_accel,
                     (printer.toolhead.max_accel_to_decel|default(printer.toolhead.max_accel, true)),
                     printer.toolhead.max_velocity,
                     printer.toolhead.square_corner_velocity)] %}
  SET_GCODE_VARIABLE MACRO=VEL_PUSH VARIABLE=stack VALUE="{s|tojson}"

[gcode_macro VEL_POP]
gcode:
  {% set cur = printer["gcode_macro VEL_PUSH"].stack %}
  {% if cur|length == 0 %}
    {action_respond_info("VEL_POP: stack empty, nothing to restore")}
  {% else %}
    {% set a, atd, v, scv = cur[-1] %}
    SET_VELOCITY_LIMIT ACCEL={a} ACCEL_TO_DECEL={atd} VELOCITY={v} SQUARE_CORNER_VELOCITY={scv}
    {% set s = cur[:-1] %}
    SET_GCODE_VARIABLE MACRO=VEL_PUSH VARIABLE=stack VALUE="{s|tojson}"
  {% endif %}


######################################################################
# Purge Logic (shared)
######################################################################

[gcode_macro PURGE_IN_CHUNKS]
description: Purges, splits long extrudes into smaller ones and poops. Accounts for pre-purged amount.
gcode:
  # --- Configurable purge ---
  {% set purge = params.PURGELENGTH|default(100)|float %}
  {% set speed = params.PURGESPEED|default(300)|float %}
  {% set already_purged = params.ALREADY_PURGED|default(0)|float %}
  {% set max_chunk = params.PURGE_MAX_CHUNK_LENGTH|default(300)|float %}
  
  # Calculate total amount that will be purged (for chunk boundary calculations)
  {% set total_purge = purge + already_purged %}
  
  # Calculate how many chunks we need for the TOTAL amount
  {% set full_chunks = (total_purge / max_chunk)|int %}
  
  # Calculate how much of the first chunk was already done
  {% set first_chunk_done = already_purged % max_chunk %}
  {% set first_chunk_remaining = max_chunk - first_chunk_done %}
  
  # If no purge needed
  {% if purge <= 0 %}
    {action_respond_info("ANY[m]: No purge needed")}
  
  # If total is less than one chunk
  {% elif full_chunks == 0 %}
    {action_respond_info("ANY[m]: Purging single chunk: %.1fmm (%.1fmm already done)" % (purge, already_purged))}
    PURGE_AND_POOP PURGELENGTH={purge} PURGESPEED={speed}
  
  # Multiple chunks needed - account for chunk boundaries
  {% else %}
    {% set remaining_to_purge = purge %}
    
    # First partial chunk (if we're in the middle of one)
    {% if first_chunk_done > 0 and first_chunk_remaining <= remaining_to_purge %}
      {action_respond_info("ANY[m]: Completing chunk %d: %.1fmm (%.1fmm already done)" % (1, first_chunk_remaining, first_chunk_done))}
      PURGE_AND_POOP PURGELENGTH={first_chunk_remaining} PURGESPEED={speed}
      {% set remaining_to_purge = remaining_to_purge - first_chunk_remaining %}
      {% set chunk_offset = 1 %}
    {% else %}
      {% set chunk_offset = 0 %}
    {% endif %}
    
    # Remaining full chunks
    {% set remaining_full_chunks = (remaining_to_purge / max_chunk)|int %}
    {% for i in range(remaining_full_chunks) %}
      {action_respond_info("ANY[m]: Purging chunk %d/%d: %.1fmm" % (
        i + 1 + chunk_offset, 
        remaining_full_chunks + chunk_offset + (1 if (remaining_to_purge - (remaining_full_chunks * max_chunk)) > 0 else 0),
        max_chunk))}
      PURGE_AND_POOP PURGELENGTH={max_chunk} PURGESPEED={speed}
    {% endfor %}
    
    # Final remainder chunk
    {% set final_remainder = remaining_to_purge - (remaining_full_chunks * max_chunk) %}
    {% if final_remainder > 0 %}
      {action_respond_info("ACE[M]: Purging final chunk %d: %.1fmm" % (
        remaining_full_chunks + chunk_offset + 1,
        final_remainder))}
      PURGE_AND_POOP PURGELENGTH={final_remainder} PURGESPEED={speed}
    {% endif %}
  {% endif %}


[gcode_macro PURGE_AND_POOP]
description: Purge
gcode:
  # --- Configurable purge ---
  {% set purge = params.PURGELENGTH|float %}
  {% set speed = params.PURGESPEED|float %}
  M83
  G92 E0  
  G1 E{purge*0.90} F{speed}
  G1 E{purge*0.10} F{speed*1.25}
  G1 E-1 F{speed*1.25}
  G92 E0
  G1 E1 F{speed*1.25}
  FLUSH_POOP


######################################################################
# Filament load / unload
######################################################################


[gcode_macro LOAD_FILAMENT]
description: Load filament
gcode:
  SAVE_GCODE_STATE NAME=LOAD_FILAMENT_STATE
  {% if "xyz" not in printer.toolhead.homed_axes %}
      G28
  {% endif %}
  TO_THROW_POSITION

  {% set min_ext = printer.configfile.settings.extruder.min_extrude_temp|default(180)|int %}
  {% set cur_temp = printer.extruder.temperature|float %}
  {% if cur_temp < min_ext %}
    {action_respond_info("ANY[m]: Heating nozzle to 245°C for load (current=%.1f°C, min=%d°C)" % (cur_temp, min_ext))}
    M109 S245
  {% else %}
    {action_respond_info("ANY[m]: Nozzle already above min_extrude_temp (%.1f°C >= %d°C)" % (cur_temp, min_ext))}
  {% endif %}

  M83
  G92 E0
  M400
  {action_respond_info("ANY[m]: Extruding 150mm...")}
  G1 E150 F300
  G92 E0

  RESTORE_GCODE_STATE NAME=LOAD_FILAMENT_STATE MOVE=0
  FLUSH_POOP

[gcode_macro UNLOAD_FILAMENT]
description: Unload filament with cutter and retract
gcode:
  SAVE_GCODE_STATE NAME=UNLOAD_FILAMENT_STATE
  {% if "xyz" not in printer.toolhead.homed_axes %}
      G28
  {% endif %}

  CUT_TIP
  M400
  {action_respond_info("ANY[m]: Retracting 100mm of filament...")}  
  FORCE_MOVE STEPPER="extruder" DISTANCE=-100 VELOCITY=10
  RESTORE_GCODE_STATE NAME=UNLOAD_FILAMENT_STATE MOVE=0

# Anycubic Slicer Next emits M900 gcode instead using the Klipper standard SET_PRESSURE_ADVANCE
# Lets map M900 to SET_PRESSURE_ADVANCE here and hope the given K value is compatible...
[gcode_macro M900]
description: "Marlin M900 compatibility: map Linear Advance K to Klipper SET_PRESSURE_ADVANCE"
gcode:
  {% set k = params.K|default(none) %}
  {% set l = params.L|default(none) %}
  {% set s = params.S|default(none) %}
  {% set t = params.T|default(none) %}

  # If no K/L provided, behave like "report"
  {% if k is none and l is none %}
    {% set e = printer.toolhead.extruder %}
    {% set pa = printer[e].pressure_advance|default(none) %}
    {% set st = printer[e].pressure_advance_smooth_time|default(none) %}
    {action_respond_info("M900 report -> EXTRUDER=%s pressure_advance=%s smooth_time=%s" % (e, pa, st))}
  {% else %}
    # Choose value: prefer K; fall back to L if K not provided
    {% set val = (k if k is not none else l) | float %}

    # Warn about Marlin-only concepts
    {% if s is not none %}
      {action_respond_info("M900 note: Klipper has no K-slot concept; ignoring S=%s" % s)}
    {% endif %}
    {% if t is not none %}
      {action_respond_info("M900 note: Klipper targets extruders by name, not T index; ignoring T=%s (using active extruder)" % t)}
    {% endif %}

    # Apply to currently active extruder unless you want to hardcode EXTRUDER=...
    SET_PRESSURE_ADVANCE ADVANCE={val}
    {action_respond_info("M900 -> SET_PRESSURE_ADVANCE ADVANCE=%.6f (active extruder)" % val)}
  {% endif %}
