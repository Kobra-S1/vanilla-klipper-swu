######################################################################
# Include Generic ACE Macros
######################################################################
# Generic macros shared between all printer types are in ace_macros_generic.cfg
# Expected supporting macros (provided by printer/printer_generic_macros):
# - CUT_TIP
# - TO_THROW_POSITION
# - RESUME_NOZZLE_WIPE_SEQUENCE
# - FLUSH_POOP
# - _PAUSE_RESUME_STATE (optional; guarded)
[include ace_macros_generic.cfg]

######################################################################
# Custom Tool Macros (Optional - For Spoolman/Extensions)
######################################################################
# ACE automatically detects custom T<n> macros and skips auto-registration.
# Use this for integrations like Spoolman: https://github.com/Donkie/Spoolman
#
# Example: Custom T0 macro with Spoolman integration
# [gcode_macro T0]
# gcode:
#     SET_ACTIVE_SPOOL ID=1
#     ACE_CHANGE_TOOL TOOL=0
#
# Example: Custom T1 macro
# [gcode_macro T1]
# gcode:
#     SET_ACTIVE_SPOOL ID=2
#     ACE_CHANGE_TOOL TOOL=1
######################################################################
# Please check that [save_variables] is above [ace] if you're using different config
[save_variables]
filename: ~/printer_data/config/saved_variables.cfg

# Workaround to get an on/off switch to toggle between ACE Pro and external spool printing
[virtual_pins]

[output_pin ACE_Pro]
pin: virtual_pin:ace_pro
pwm: False
value: 1
shutdown_value: 0

[respond]

[ace]
ace_count: 1
baud: 115200
#Mapping of filament runout sensors in ACE to printer sensors (K3 has no RDM sensor)
#filament_runout_sensor_name_rdm: filament_runout_rdm
filament_runout_sensor_name_nozzle: filament_runout_nozzle

# Default state of feed-assist after ACE connect/re-connect.
# This controls if ACE automatically starts pushing out filament of the last active slot after startup,
# unless it detects resistance via the rear buffer-filament sensors and stops.
feed_assist_active_after_ace_connect: True

# Connection supervision: monitors ACE connection stability and shows dialog/pauses print
# if connection becomes unstable (6+ reconnects in 3 minutes). Set to False to disable.
#ace_connection_supervision: True

# RFID temperature mode: how to calculate print temp from RFID tag min/max values
# Options: average (default), min, max
# Example: RFID tag with extruder_temp: {min: 190, max: 230}
#   average -> (190 + 230) / 2 = 210°C
#   min -> 190°C
#   max -> 230°C
#rfid_temp_mode: average

# Default feeding speed
feed_speed: 60
# Default retraction speed
retract_speed: 50

# Value must be greater than the tube length, as it will cause an error and pause the print if more than
# this amount is fed (and toolhead filament sensor has not triggered).
total_max_feeding_length: 2600

# Tube length between filament detection sensor on toolhead and ACE filament parking position
# (where filament is automatically fed by ACE when a new spool is inserted).
# This is the distance filament needs to be retracted to free the path for other filament.
# Should be slightly greater than actual tube length.
parkposition_to_toolhead_length: 115
parkposition_to_rdm_length: 0

# Length of filament (after extruder_feeding) to feed from toolhead extruder to nozzle, so it's primed to extrude.
toolhead_full_purge_length: 60
toolhead_slow_loading_speed: 6
toolhead_retraction_speed: 5
toolhead_retraction_length: 55
# Should be roughly the length between ACE and the printer's 4-in-1 splitter.
toolchange_load_length: 3000 

#max_dryer_temperature: 55

# Length and speed to feed from ACE and extrude after toolhead sensor has triggered
# (to ensure extruder gears have grabbed the filament securely).
extruder_feeding_length: 45
extruder_feeding_speed: 4


default_color_change_purge_length: 50
default_color_change_purge_speed: 300
purge_max_chunk_length: 250
purge_multiplier: 1.0
# How much filament to feed incrementally as a retry if initial loading failed
# (stops if total_max_feeding_length is reached).
incremental_feeding_length: 100 
incremental_feeding_speed: 60 

pre_cut_retract_length: 2  # Length to retract before CUT_TIP is called

