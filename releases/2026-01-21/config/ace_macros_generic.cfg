# ============================================================================
# ACE Pro Generic Macros - Reusable Across All Printer Types
# ============================================================================
# This file contains ACE-related macros that are printer-agnostic.
# Include this in your printer-specific ace configuration file, e.g. ace_K3.cfg or ace_KS1.cfg
# ============================================================================
# External macros expected (provided by printer configs / generic macros):
# - CUT_TIP
# - TO_THROW_POSITION
# - RESUME_NOZZLE_WIPE_SEQUENCE
# - FLUSH_POOP
# - _PAUSE_RESUME_STATE (optional; guarded)


# The following two macro are internal helper macros for manual extrusion/retraction, used by dialog boxes.
# Dont rely on them outside of that context.
[gcode_macro _EXTRUDE]
description: Extrude filament for manual loading
gcode:
  {% set length = params.LENGTH|default(50)|float %}
  {% set speed  = params.SPEED|default(300)|float %}
  {% set min_temp = printer.configfile.settings.extruder.min_extrude_temp|default(200)|int %}
  {% set current_temp = printer.extruder.temperature|float %}
  {% set target_temp = printer.extruder.target|int %}

  # Check if we need to heat
  {% if current_temp < min_temp %}
    {% set heat_target = target_temp if target_temp >= min_temp else (min_temp + 10) %}
    { action_respond_info("_EXTRUDE: Heating to %d°C (current: %.1f°C)" % (heat_target, current_temp)) }
    M109 S{heat_target}
  {% endif %}

  SAVE_GCODE_STATE NAME=ace_extrude
  G91
  G1 E{length} F{speed}
  G90
  RESTORE_GCODE_STATE NAME=ace_extrude

[gcode_macro _RETRACT]
description: Retract filament for manual unloading
gcode:
  {% set length = params.LENGTH|default(50)|float %}
  {% set speed  = params.SPEED|default(300)|float %}
  {% set min_temp = printer.configfile.settings.extruder.min_extrude_temp|default(200)|int %}
  {% set current_temp = printer.extruder.temperature|float %}
  {% set target_temp = printer.extruder.target|int %}

  # Check if we need to heat
  {% if current_temp < min_temp %}
    {% set heat_target = target_temp if target_temp >= min_temp else (min_temp + 10) %}
    { action_respond_info("_RETRACT: Heating to %d°C (current: %.1f°C)" % (heat_target, current_temp)) }
    M109 S{heat_target}
  {% endif %}

  SAVE_GCODE_STATE NAME=ace_retract
  G91
  G1 E-{length} F{speed}
  G90
  RESTORE_GCODE_STATE NAME=ace_retract

######################################################################
# ACE State Management
######################################################################

[gcode_macro _ACE_STATE]
# state for resume/toolchange
variable_orig_target: 0
variable_bumped: 0
variable_startup_toolchange: 0
variable_active: -1
variable_heating_temperature: 0
variable_prev_tool_heating_temperature: 0
variable_pre_toolchange_fan: 0
gcode:
    # no gcode — just holds variables



######################################################################
# ACE Preparation Macros
######################################################################

[gcode_macro _ACE_PREPARE_FOR_RETRACTION]
description: Handle heating and CUT_TIP for retraction
gcode:
  {% set target_temp      = params.TARGET_TEMP|default(0)|int %}
  {% set pre_cut_retract  = params.PRE_CUT_RETRACT|default(2)|float %}
  {% set current_temp     = printer.extruder.temperature|float %}
  {% set current_target   = printer.extruder.target|int %}
  {% set min_extrude_temp = printer.configfile.settings.extruder.min_extrude_temp|default(170)|int %}

  # Only heat if current temp OR target are below min_extrude_temp
  {% if current_temp < min_extrude_temp or current_target < min_extrude_temp %}
    {% set heat_temp = target_temp if target_temp >= min_extrude_temp else (min_extrude_temp + 10) %}
    { action_respond_info("ACE: PREPARE_RETRACT - heating to %d°C" % heat_temp) }
    M109 S{heat_temp}
  {% else %}
    { action_respond_info("ACE: PREPARE_RETRACT - already hot enough (%.1f°C)" % current_temp) }
  {% endif %}

  # Small retract before cut
  {% if pre_cut_retract > 0 %}
    { action_respond_info("ACE: PREPARE_RETRACT - pre-cut retract %.1fmm" % pre_cut_retract) }
    G1 E-{pre_cut_retract} F600
  {% endif %}
  
  # Run CUT_TIP if present
  {% if printer["gcode_macro CUT_TIP"] is defined %}
    { action_respond_info("ACE: PREPARE_RETRACT - cutting tip") }
    CUT_TIP
  {% else %}
    { action_respond_info("ACE: CUT_TIP macro not available") }
  {% endif %}


######################################################################
# Pre/Post Toolchange
######################################################################

[gcode_macro _ACE_PRE_TOOLCHANGE]
description: Pre-toolchange prep with smart temperature management
variable_min_zhop: 4
variable_allow_unhomed_zhop: 0
gcode:
  {% if printer["output_pin ACE_Pro"].value %}
    { action_respond_info("ACE[M]: Pre toolchange") }

    # --- Temperatures ---
    {% set current_target   = printer.extruder.target|int %}
    {% set current_temp     = printer.extruder.temperature|float %}
    {% set min_extrude      = printer.configfile.settings.extruder.min_extrude_temp|default(170)|int %}
    {% set inventory_temp   = params.TARGET_TEMP|default(0)|int %}
    {% set is_paused        = printer.pause_resume.is_paused|int %}
    
    {% set pre_pause_temp = 0 %}
    {% if is_paused and printer["gcode_macro _PAUSE_RESUME_STATE"] is defined %}
      {% set pre_pause_temp = printer["gcode_macro _PAUSE_RESUME_STATE"].pre_pause_temp|default(0)|int %}
      {% if pre_pause_temp > 0 %}
        { action_respond_info("ACE[M]: PRE - paused state, using saved pre-pause temp %d°C" % pre_pause_temp) }
      {% endif %}
    {% endif %}

    # Remember original target for POST (use pre_pause_temp if available)
    {% set orig_temp = pre_pause_temp if pre_pause_temp > 0 else current_target %}
    SET_GCODE_VARIABLE MACRO=_ACE_STATE VARIABLE=orig_target VALUE={orig_temp}

    # --- Safe Z-hop before moves ---
    {% set zmin = printer.toolhead.axis_minimum.z|float %}
    {% set zmax = printer.toolhead.axis_maximum.z|float %}
    {% set margin = 0.2 %}
    {% set min_zhop = printer["gcode_macro _ACE_PRE_TOOLCHANGE"].min_zhop|float %}
    {% set curz = printer.toolhead.position.z|float %}
    # Save Z/E state before any Z-hop
    SAVE_GCODE_STATE NAME=purge_state
    {% if curz < 4.0 %}
      {% set target_z = 4.0 if 4.0 < (zmax - margin) else (zmax - margin) %}
      { action_respond_info("ACE[M]: Z-hop: curz < 4mm, moving to %.3f" % target_z) }
      G90
      G1 Z{ target_z|round(3) } F300
      M400
    {% else %}
      {% set lift_z = curz + 2.0 %}
      {% set target_z = lift_z if lift_z < (zmax - margin) else (zmax - margin) %}
      { action_respond_info("ACE[M]: Z-hop: curz >= 4mm, lifting by 2mm to %.3f" % target_z) }
      G90
      G1 Z{ target_z|round(3) } F300
      M400
    {% endif %}

    # Save current fan speed and disable part cooling fan
    {% set current_fan = printer.fan.speed|default(0.0)|float %}
    {% set current_fan_pwm = (current_fan * 255)|int %}
    SET_GCODE_VARIABLE MACRO=_ACE_STATE VARIABLE=pre_toolchange_fan VALUE={current_fan_pwm}
    { action_respond_info("ACE[M]: PRE - saving fan speed (%d PWM) and disabling" % current_fan_pwm) }
    M106 S0

    # Move to throw position ready for ACE swap
    TO_THROW_POSITION

    # Decide target temp: pre_pause > slicer > inventory > fallback
    {% if pre_pause_temp > 0 %}
      { action_respond_info("ACE[M]: PRE - using pre-pause temp %d°C" % pre_pause_temp) }
      {% set target_temp = pre_pause_temp %}
    {% elif current_target > 0 %}
      { action_respond_info("ACE[M]: PRE - using slicer temp %d°C (printing)" % current_target) }
      {% set target_temp = current_target %}
    {% elif inventory_temp >= min_extrude %}
      { action_respond_info("ACE[M]: PRE - using inventory temp %d°C (manual)" % inventory_temp) }
      {% set target_temp = inventory_temp %}
      M104 S{target_temp}
    {% else %}
      {% set target_temp = (min_extrude + 30)|int %}
      { action_respond_info("ACE[M]: PRE - using fallback temp %d°C" % target_temp) }
      M104 S{target_temp}
    {% endif %}

    # Heat if needed
    {% if current_temp < target_temp-10 %}
      { action_respond_info("ACE[M]: PRE - heating to %d°C..." % target_temp) }
      M109 S{target_temp}
    {% else %}
      { action_respond_info("ACE[M]: PRE - already at %.1f°C" % current_temp) }
    {% endif %}

  {% else %}
    { action_respond_info("ACE[M]: WARNING: ACE disabled!") }
  {% endif %}


[gcode_macro _ACE_POST_TOOLCHANGE]
description: Post-toolchange with purge and temperature restoration
gcode:
   # --- Configurable purge ---
  {% set purge = params.PURGELENGTH|default(50)|float %}
  {% set speed = params.PURGESPEED|default(200)|float %}
  {% set already_purged = params.PURGED_AMOUNT|default(0)|float %}
  {% set purge_max_chunk_length = params.PURGE_MAX_CHUNK_LENGTH|default(300)|float %}
  
  {% if printer["output_pin ACE_Pro"].value %}
    {action_respond_info("ACE[M]: Post toolchange")}


    # --- Temperature decisions ---
    {% set st             = printer["gcode_macro _ACE_STATE"] %}
    {% set orig_temp      = st.orig_target|int %}
    {% set current_temp   = printer.extruder.temperature|float %}
    {% set inventory_temp = params.TARGET_TEMP|default(0)|int %}

    {% if orig_temp > 0 %}
      {% set purge_temp = orig_temp %}
    {% elif inventory_temp > 0 %}
      {% set purge_temp = inventory_temp %}
    {% else %}
      {% set purge_temp = 190 %}
    {% endif %}

    {% if current_temp < purge_temp-10.0 %}
      { action_respond_info("ACE[M]: POST - heating to %d°C for purge" % purge_temp) }
      M109 S{purge_temp}
    {% endif %}

    {% if already_purged > 0 %}
      { action_respond_info("ACE[M]: Already purged %.1fmm during toolhead pre-loading, purging additional %dmm at %dmm/min (%.1f°C)" % (already_purged, purge|int, speed|int, current_temp)) }
    {% else %}
      { action_respond_info("ACE[M]: Purging %dmm at %dmm/min (%.1f°C)" % (purge|int, speed|int, current_temp)) }
    {% endif %}

    # Get saved fan speed from PRE macro, or use current fan as fallback
    {% set saved_fan_pwm = st.pre_toolchange_fan|default(0)|int %}
    {% if saved_fan_pwm == 0 %}
      {% set current_fan = printer.fan.speed|default(0.0)|float %}
      {% set saved_fan_pwm = (current_fan * 255)|int %}
      { action_respond_info("ACE[M]: POST - no saved fan speed, using current fan (%d PWM)" % saved_fan_pwm) }
    {% endif %}

    {% if purge > 0 %}
      M83
      G92 E0
      M106 S0
      PURGE_IN_CHUNKS PURGELENGTH={purge} PURGESPEED={speed} ALREADY_PURGED={already_purged} PURGE_MAX_CHUNK_LENGTH={purge_max_chunk_length}
    {% endif %}
    
    # --- Wipe / shake sequence, optional skip for startup toolchange ---
    {% set skip_wipe = st.startup_toolchange|default(0)|int %}
    {% if skip_wipe == 1 %}
      SET_GCODE_VARIABLE MACRO=_ACE_STATE VARIABLE=startup_toolchange VALUE=0
    {% else %}
      RESUME_NOZZLE_WIPE_SEQUENCE
    {% endif %}
    
    # Restore fan speed (from PRE or current)
    { action_respond_info("ACE[M]: POST - restoring fan speed to %d PWM" % saved_fan_pwm) }
    M106 S{saved_fan_pwm}

    # --- Restore temperature policy ---
    {% if orig_temp == 0 %}
      { action_respond_info("ACE[M]: POST - turning off heater (was manual toolchange)") }
      M104 S0
    {% else %}
      { action_respond_info("ACE[M]: POST - restoring temp to %d°C (was printing)" % orig_temp) }
      M104 S{orig_temp}
    {% endif %}


    RESTORE_GCODE_STATE NAME=purge_state MOVE=1
    G92 E0


  {% else %}
    {action_respond_info("ACE[M]: WARNING: ACE disabled!")}
  {% endif %}


######################################################################
# Utility Shortcuts
######################################################################

[gcode_macro TR]
description: Shortcut to retract/change tool via ACE
gcode:
  ACE_CHANGE_TOOL TOOL=-1
