#####################################################################
#   Spoolman & ACE Integration for Anycubic Kobra 3 / S1
#####################################################################
#
# PREREQUISITES:
# 1. Spoolman must be installed and configured in moonraker.conf.
# 2. [save_variables] MUST be defined in your printer configuration 
#    (usually provided by ace_KS1.cfg or ace_K3.cfg).
#
# HOW TO USE:
#
# A) Rewritable RFID Tags (Custom Tags):
#    - Write the Spoolman Spool-ID (Integer, e.g., "15") directly onto the tag.
#    - The logic will automatically load Spool ID #15.
#
# B) Original Anycubic RFID Tags (Locked):
#    - You cannot overwrite these tags.
#    - Map the Anycubic SKU (e.g., "HPL17-103") to your Spoolman ID 
#      inside the macro '_SET_SPOOL_BY_TOOL' below.
#      (Look for the variable "sku_map").
#
# C) Manual Assignment (No RFID):
#    - Use the macro: SPOOLMAN_MANUAL_SLOT SLOT=<0-3> ID=<Spool_ID>
#    - Example: SPOOLMAN_MANUAL_SLOT SLOT=1 ID=5
#      (Locks Slot 1 to Spoolman ID 5 until the spool is removed).
#
#####################################################################

[gcode_macro SET_ACTIVE_SPOOL]
gcode:
  {% if params.ID and params.ID|int > 0 %}
    {action_call_remote_method("spoolman_set_active_spool", spool_id=params.ID|int)}
  {% else %}
    {action_call_remote_method("spoolman_set_active_spool", spool_id=None)}
  {% endif %}

[gcode_macro CLEAR_ACTIVE_SPOOL]
gcode:
  {action_call_remote_method("spoolman_set_active_spool", spool_id=None)}

[gcode_macro _SET_SPOOL_BY_TOOL]
gcode:
    {% set tool = params.TOOL|int %}
    {% set sv = printer.save_variables.variables %}
    
    {% set inv_key = 'ace_inventory_0' if tool < 4 else 'ace_inventory_1' %}
    {% set inv_idx = tool if tool < 4 else tool - 4 %}
    {% set hw_sku = "none" %}
    {% set hw_status = "unknown" %}
    
    {% if inv_key in sv %}
        {% set hw_sku = sv[inv_key][inv_idx].sku|default("none")|string|trim %}
        {% set hw_status = sv[inv_key][inv_idx].status|default("unknown")|string %}
    {% endif %}

    {% set m_id = sv["manual_spool_id_" ~ tool]|default(0)|int %}
    {% set m_lock_sku = sv["manual_spool_lock_sku_" ~ tool]|default("none")|string %}

    {% set rfid_id = 0 %}
    {% set sku_map = {'HPL17-103': 1, 'HPL16-107': 2, 'HPL19-106': 3} %} #Translator to map Anycubic (or any other know SKU) --> corresponding Spoolman ID
    
    # check if SKU is a number (f.e. "5")
    {% if hw_sku in sku_map %}
        {% set rfid_id = sku_map[hw_sku] %}
    {% elif hw_sku | int(0) > 0 %}
        {% set rfid_id = hw_sku | int %}
    {% endif %}

    {% if hw_status == "empty" %}
        CLEAR_ACTIVE_SPOOL
    {% elif m_id > 0 and hw_sku == m_lock_sku %}
        SET_ACTIVE_SPOOL ID={m_id}
        {action_respond_info("Spoolman: manually lock (ID %d) fÃ¼r Slot %d" % (m_id, tool))}
    {% elif rfid_id > 0 %}
        {% if m_id > 0 and hw_sku != m_lock_sku %}
            SAVE_VARIABLE VARIABLE=manual_spool_id_{tool} VALUE=0
        {% endif %}
        SET_ACTIVE_SPOOL ID={rfid_id}
        {action_respond_info("Spoolman: RFID-ID %d loaded (Slot %d)" % (rfid_id, tool))}
    {% else %}
        CLEAR_ACTIVE_SPOOL
        {action_respond_info("Spoolman: No ID found for SKU '%s' gefunden (Slot %d)" % (hw_sku, tool))}
    {% endif %}

[gcode_macro SPOOLMAN_MANUAL_SLOT]
description: Links a manual ID to the current spool in the slot
gcode:
    {% set slot = params.SLOT|default(-1)|int %}
    {% set id = params.ID|default(0)|int %}
    
    {% if slot >= 0 and slot <= 7 %}
        {% set sv = printer.save_variables.variables %}
        
        # 1. Read current hardware SKU from ACE inventory
        {% set inv_key = 'ace_inventory_0' if slot < 4 else 'ace_inventory_1' %}
        {% set inv_idx = slot if slot < 4 else slot - 4 %}
        {% set current_hw_sku = "none" %}
        
        {% if inv_key in sv %}
            {% set current_hw_sku = sv[inv_key][inv_idx].sku|default("none")|string %}
        {% endif %}

        # 2. save the ID AND the SKU to which this ID should apply.
        SAVE_VARIABLE VARIABLE=manual_spool_id_{slot} VALUE={id}
        SAVE_VARIABLE VARIABLE=manual_spool_lock_sku_{slot} VALUE='"{current_hw_sku}"'
        
        {action_respond_info("Spoolman: Slot %d manually locked to ID %d (base SKU: %s)" % (slot, id, current_hw_sku))}
    {% else %}
        {action_respond_info("Error: SLOT must be between 0 and 7.")}
    {% endif %}

#####################################################################
#   T-macros trigger tool changes Spoolman
#####################################################################

[gcode_macro T0]
gcode: 
  _SET_SPOOL_BY_TOOL TOOL=0
  ACE_CHANGE_TOOL TOOL=0

[gcode_macro T1]
gcode: 
  _SET_SPOOL_BY_TOOL TOOL=1
  ACE_CHANGE_TOOL TOOL=1

[gcode_macro T2]
gcode: 
  _SET_SPOOL_BY_TOOL TOOL=2
  ACE_CHANGE_TOOL TOOL=2

[gcode_macro T3]
gcode: 
  _SET_SPOOL_BY_TOOL TOOL=3
  ACE_CHANGE_TOOL TOOL=3

[gcode_macro T4]
gcode: 
  _SET_SPOOL_BY_TOOL TOOL=4
  ACE_CHANGE_TOOL TOOL=4

[gcode_macro T5]
gcode: 
  _SET_SPOOL_BY_TOOL TOOL=5
  ACE_CHANGE_TOOL TOOL=5

[gcode_macro T6]
gcode: 
  _SET_SPOOL_BY_TOOL TOOL=6
  ACE_CHANGE_TOOL TOOL=6

[gcode_macro T7]
gcode: 
  _SET_SPOOL_BY_TOOL TOOL=7
  ACE_CHANGE_TOOL TOOL=7
